<p>Цифровой сертификат представляет из себя пару приватный ключ -  публичный ключ и предназначен для осуществления асимметричного  обратимого шифрования. Шифрование осущ6ествляется приватным ключем,  расшифровка - публичным, таким образом подменить данные не имея  приватного ключа не получится.</p>
<p>Для подтверждения достоверности сертификата (Subject) его должен  подписать один из доверенных корневых центров или один из его дочерних  сертификатов (Issuer). Таким образом сертификаты относительно друг друга  имеют древовидную структуру.</p>
<p>Для разработки возможно создать собственный корневой сертификат не  подписаный ни одним из доверенных корневых центров (таким образом все  программы, работающие с сертификатами могут сказать "я ему не верю") -  такой сертификат называется самоподписанным (self-signed)</p>
<p>Так же сертификаты имеют различное назначение (такие как подписывание кода, серверная или клиентская авторизация и т.д.)</p>
<p>В статье рассматриваются способы создания и применения сертификатов</p>
<p> </p>
<h1>Назначение сертификатов</h1>
<hr />
<p>Для описания назначения сертификата испозьуются специальные коды. Например:</p>
<p>1.3.6.1.5.5.7.3.1 - Серверная авторизация<br />1.3.6.1.5.5.7.3.2 - Клиентская авторизация<br />1.3.6.1.5.5.7.3.3 - Подпись кода<br />1.3.6.1.5.5.7.3.4 - Защита почты</p>
<p>На самом деле для любой задачи можно использовать любой сертификат,  однако программы по работе с ними должны следить за тем, что  использование сертификата соответствует своему назначению.</p>
<p> </p>
<h1>Создание сертификатов</h1>
<hr />
<p>Существует несколько программ для генерации сертификатов:</p>
<p><a href="#makecert" title="makecert">makecert </a>- Программа по созданию сертификатов от M$ (Certificate Creation Tool) <br /><a href="#openssl" title="openssl">openssl </a>- Программа по работе с сертификатами (в т.ч. создание списков отзыва) с открытым исходным кодом и работающая под разными ОС</p>
<p>Так же естесственно существует возможность генерации сертификатов программным путем:</p>
<p><a href="https://gist.github.com/ApmeM/1d4883e21de322d13efe8b2bdef1ad5c">.Net</a> (необходимо скачать <a href="http://www.bouncycastle.org/">BouncyCastle</a>)</p>
<p> </p>
<h2><a name="makecert"></a>makecert</h2>
<p>Программа предназначена для создания сертификатов, их подписи и размещения полученного сертификата в хранилищах. В установленном варианте располагается в "C:\\Program Files (x86)\\Microsoft SDKs\\Windows\\v7.0A\\Bin\\makecert.exe" или очень похожем месте.</p>
<p>Большинство параметров системы одинаковы для Issuer (те, которые были  заданы при создании этого сертификата) и Subject (те, которые будут  заданы новому сертификату)</p>
<p>- sp / ip - название криптопровайдера<br />- sy / iy - тип криптопровайдера<br />- sc / ic - путь к публичному ключу (сертификату без приватного ключа)<br />- sv / iv - путь к приватному ключу</p>
<p>- ss / is - название хранилища (My, Root)<br />- sr / ir - расположение хранилища (currentUser, localMachine)</p>
<p>Остальные параметры тносятся только к новому генерируемому сертификату:</p>
<p>- r - создать самоподписный сертификат<br />- pe - сделать сертификат экспортируемым (имеет смысл при использовании автоматического занесения в хранилище)<br />- n - описание сертификата в формате name=value разделенных запятыми (CN=test,O=test)<br />- eku - назначение сертификата<br />- sky - тип ключа (exchange=1, signature=2)<br />- b - срок начала действия<br />- e - срок окончания действия</p>
<p>Пример использования:</p>
<pre>rem Создание самоподписанного корневого сертификата в файлы ca.pvk и ca.cer<br />makecert -r -n "CN=Example CA"                         -sky exchange <br />  -sp "Microsoft RSA SChannel Cryptographic Provider" -sy 12 <br />  -sv ca.pvk ca.cer<br />rem Создание серверного сертификата localhost.pvk и localhost.cer подписанного корневым сертификатом<br />makecert    -n "CN=localhost" -eku "1.3.6.1.5.5.7.3.1" -sky exchange <br />  -sp "Microsoft RSA SChannel Cryptographic Provider" -sy 12 <br />  -ic ca.cer -iv ca.pvk <br />  -sv localhost.pvk localhost.cer</pre>
<p>Для получения одного файла из 2х ключей (например для регистрации в  браузере) используется программа pvk2pfx, в качестве параметров которой  передаются 2 ключа и имя получаемого файла:</p>
<pre>pvk2pfx.exe -pvk localhost.pvk -spc localhost.cer -pfx localhost.pfx<br /></pre>
<h2><a name="openssl"></a>openssl</h2>
<p>Эта программа гораздо более функциональна, однако с ее настройкой и  использованием все гораздо сложнее. Тут я рассмотрю только  варианты создания CA, client и server сертификатов (как и для makecert).  Использование программы и ее параметры продемонстрирую на примере.  Дополнительные примеры можно посмотреть в --help по команде:</p>
<ol>
<li> Сгенерировать новый RSA ключ. Если не указан параметр \'-out  filename.pvk\' ключ будет выведен на стандартный вывод. При желании ключ  можно зашифровать методом des3 при помощи параметра \'-des3:<br />
<pre>openssl genrsa -out ca.pvk</pre>
</li>
<li>Создать запрос на создание сертификата. В качестве входного  параметра необходимо передать приватный ключ \'-key ./ca.pvk\' и указание,  что это новый запрос \'-new\'. так же имеет параметр -out для выходного  ключа. Для работы этой команды из конфигурационного файла openssl.cnf  берется раздел [ req ]. В нем содержится список полей, запрашиваемых для  заполнения. Для изменения используемого конфигурационного файла  используется параметр \'-config filename.cnf\'<br />
<pre>openssl req -config ./openssl.cnf -new -key ./ca.pvk -out ca.csr</pre>
</li>
<li>Подписать запрос приватным ключем и создаем самоподписанный сертификат<br />
<pre>openssl x509 -extfile ./openssl.cnf -extensions v3_ca -req -days 365 <br />-in ca.csr -signkey ca.pvk -out ca.crt<br /></pre>
</li>
<li>
<p>Для того объединения приватного ключа и сертификата в кучку в формате  pkcs12 существует специальная команда pkcs12 :) в качестве входных  параметров необходимо передать приватный ключ и сертификат. Для создания  алиаса (иногда используется) необходимо передать параметр \'-name  "alias"\'. Выходной параметр -out все так же необязателен:</p>
<pre>openssl pkcs12 -export -in ca.crt -inkey ca.pvk -name "alias" -out ca.pfx</pre>
</li>
<li>
<p>После выполнения всех команд в каталоге должны присутствовать файлы ca.pvk, ca.crt, ca.csr (больше не нужен) и ca.pfx</p>
</li>
</ol>
<p style="padding-left: 30px;">ВНИМАНИЕ: При указании в п.2 параметра -keyout вместо -key, приватный ключ юудет сгенерирован автоматически</p>
<p>Для создания самоподписанного сертификата в openssl.cnf должно содержаться:</p>
<pre>[ req ]<br />distinguished_name  = req_distinguished_name<br /><br />[ req_distinguished_name ]<br />commonName          = Common Name (eg, YOUR name)<br />commonName_max          = 64<br />organizationName        = Organization Name (eg, company)<br />organizationName_default    = ApmeM.org<br />organizationalUnitName      = Organizational Unit Name (eg, section)<br />organizationalUnitName_default  = Developer<br /><br />[ v3_ca ]<br />subjectKeyIdentifier=hash<br />authorityKeyIdentifier=keyid:always,issuer:always<br />basicConstraints = CA:true</pre>
<p>Для создания клиентского или серверного сертификата требуется  провести почти идентичную процедуру. Пункты 1, 2 и 4 остаются без  изменений (кроме имен файлов). а пункт 3 изменяется. Во первых  подключается использование ca сертификатов в генерации нового  сертификата и во вторых меняется расширение на v3_server (его нет по  умолчанию в стандартном openssl.cnf):</p>
<pre>openssl ca -config ./openssl.cnf -days 365 -cert ca.crt -keyfile ca.pvk<br />     -extensions v3_server -extfile ./openssl.cnf -out server.crt -infiles server.csr</pre>
<p>для работы этой строки openssl.cnf должен выглядеть так:</p>
<pre>[ ca ]<br />default_ca  = CA_default<br /><br />[ CA_default ]<br />dir     = .<br />database    = $dir/index.txt<br />new_certs_dir   = $dir<br />serial      = $dir/serial.txt<br />default_md  = sha1<br />policy      = policy_match<br /><br />[ policy_match ]<br />commonName      = supplied<br /><br />[ v3_server ]<br />extendedKeyUsage = 1.3.6.1.5.5.7.3.1<br />subjectKeyIdentifier=hash<br />basicConstraints = CA:false</pre>
<p>И исходя из текста файла необходимо иметь файл index.txt (в начале  пустой, создается командой touch. Со временем заполниться списком  создаваемых сертификатов) и serial.txt (автоинкрементное значение,  изначально можно установить в 01. В результате работы становится  серийным номером нового сертификата)</p>
<p>Иногда необходимо получить публичный ключ по его приватному ключу  отдельно от всех остальных операций. Для этого необходимо выполнить  такую команду (как обычно out необязательно. outform  может быть pem =  base64 или der = бинарный)</p>
<pre>openssl rsa -in ./server.pvk -pubout -outform pem -out ./server.pub<br /></pre>
<p> </p>
<h1>Применение сертификатов</h1>
<hr />
<p>Одним из способов применения сертификатов является установка  защищенного соединения браузера с веб сервером, а также возможная  авторизация на сайте при помощи клиентского сертификата.</p>
<h2>IIS</h2>
<p>Для применения сертификата в IIS необходимо зарегистрировать корневой  и серверные сертификаты в локальном хранилище (серверный сертификат в  разделе Personal и корневой в разделе Trusted Root Certfication  Authorities). Для этого можно использовать mmc.</p>
<p style="padding-left: 30px;">ВНИМАНИЕ: по умолчанию при импорте в  диалоге выбора сертификата стоит фильтр *.cer, таким образом приватный  ключ ипортирован не будет. Необходимо выбрать *.pfx фильтр.</p>
<p>После того, как сертификаты загружены необходимо сказать IIS об их  использовании. Указание сертификата для создания защищенного соединения  осуществляется на весь сайт в целом, однако использование клиентского  сертификата можно устанавливать на отдельно взятые виртуальные папки.</p>
<p>Для добавления сертификата на сайт, в настройках сайта на вкладке  Directory Security есть кнопка Server Certificate. После чего у всех  виртуальных папок этого сайта в настроках появится возможность  редактировать использование защищенного соединения.</p>
<p style="padding-left: 30px;">ВНИМАНИЕ: Для того, чтобы браузер не  сильно ругался на недостоверный сертификат необходимо, чтобы Common Name  (CN=) совпадал с названием сайта (в нашем случае localhost)</p>
<p>После этого доступ через https должен работать.</p>
<p>Для осуществления авторизации по клиентскому сертификату загрузите  его в браузер в раздел Personal, на главной странице напишите:</p>
<pre>HttpClientCertificate cert = Request.ClientCertificate;<br />if (cert.IsPresent)<br />{<br />    label1.Text = cert.Subject;<br />}</pre>
<p>и откройте сайт. В нашем случае должно отобразиться "CN=test".</p>
<p>Так же при помощи настроек самого ииса возможно сделать соответствие  сертификата пользователя windows и сертификата и многое другое.</p>
<p> </p>
<h1>Отстрел багов</h1>
<hr />
<ol>
<li><span style="line-height: 1.3em;">При появлении ошибки "</span>CryptographicException: Набор ключей не существует<span style="line-height: 1.3em;">" или "</span>ArgumentException: Возможно, что сертификат "CN=localhost" не имеет закрытого ключа, который может использоваться для обмена ключами, или у процесса нет прав доступа к закрытому ключу. Дополнительные сведения см. в тексте внутреннего исключения" Необходимо дать права пользователю, из под которого выполняется процесс на доступ к приватным ключам.   
<ul>
<li><span style="line-height: 1.3em;">Открыть mmc -&gt; File -&gt; Add Certificates (Local computer) snap-in -&gt; Certificates (Local Computer) -&gt; Personal -&gt; Certificates -&gt; Right click the certificate -&gt; All tasks -&gt; Manage private keys</span></li>
<li><span style="line-height: 1.3em;">Add user and grant it Full control. </span></li>
<li><span style="line-height: 1.3em;">For IIS it is IIS_IUSRS</span></li>
</ul>
</li>
</ol>
<h1>Полезные ссылки                                                                                                              
<hr />
</h1>
<p><a href="http://www.bouncycastle.org/">http://www.bouncycastle.org/</a> - библиотека для работы с сертификатами (есть как для .Net, так и для Java)</p>
<p><a href="http://msdn.microsoft.com/en-us/library/bfsktky3%28VS.80%29.aspx">http://msdn.microsoft.com/en-us/library/bfsktky3%28VS.80%29.aspx</a> - описание работы makecert.exe с примерами</p>
